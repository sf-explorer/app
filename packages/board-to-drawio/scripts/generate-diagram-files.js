#!/usr/bin/env node

/**
 * Generate individual markdown files for each diagram with viewer URLs
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { transformBoardWithViewerUrl } from '../dist/index.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const boardsDir = path.join(__dirname, '../../../Boards');
const diagramsDir = path.join(__dirname, '../docs/diagrams');

// Ensure diagrams directory exists
if (!fs.existsSync(diagramsDir)) {
  fs.mkdirSync(diagramsDir, { recursive: true });
}

// Get all JSON board files
const boardFiles = fs.readdirSync(boardsDir)
  .filter(file => file.endsWith('.json'))
  .sort();

console.log(`ğŸ“Š Generating individual diagram files for ${boardFiles.length} diagrams...\n`);

const diagrams = [];

// Process each board
for (const boardFile of boardFiles) {
  const boardPath = path.join(boardsDir, boardFile);
  const boardName = path.basename(boardFile, '.json');
  
  try {
    // Read board data
    const boardData = JSON.parse(fs.readFileSync(boardPath, 'utf-8'));
    
    // Skip if not a valid board template
    if (!boardData.nodes || !boardData.edges) {
      console.log(`âŠ˜ ${boardName} (not a board template, skipping)`);
      continue;
    }
    
    // Check for annotation
    const hasAnnotation = boardData.nodes.some(n => n.data?.annotation);
    
    // Transform and get viewer URL
    const { xml, viewerUrl } = transformBoardWithViewerUrl(boardData, {
      includeReadOnlyFields: false,
      showFieldTypes: true,
      tableWidth: 220,
      fieldHeight: 28,
      title: boardName
    });
    
    const urlLength = viewerUrl.length;
    const displayName = boardName.replace(/([A-Z])/g, ' $1').trim().replace(/^./, str => str.toUpperCase());
    
    // Create individual diagram file
    const diagramMarkdown = `# ${displayName}

## ğŸ“Š Diagram Information

- **File:** [\`${boardName}.drawio\`](../../output/${boardName}.drawio)
- **Nodes:** ${boardData.nodes.length} tables/entities
- **Edges:** ${boardData.edges.length} relationships
- **URL Size:** ${urlLength.toLocaleString()} characters (${(urlLength/1024).toFixed(1)}KB)
${hasAnnotation ? '- **â­ Special:** Contains annotation badges\n' : ''}

## ğŸš€ Quick Actions

### View Online
[ğŸ”— **Open in draw.io viewer** â†’](${viewerUrl})

> **Note:** This diagram can be viewed directly in your browser. Click the link above to open it in the draw.io viewer.

### Download & Edit
1. Download [\`${boardName}.drawio\`](../../output/${boardName}.drawio)
2. Open with [draw.io desktop](https://github.com/jgraph/drawio-desktop/releases) or [VS Code](https://marketplace.visualstudio.com/items?itemName=hediet.vscode-drawio)
3. Edit and save locally

### Open in App
- [Open in draw.io web app](https://app.diagrams.net)
- Then: File â†’ Open â†’ Select \`${boardName}.drawio\`

## ğŸ¨ Diagram Features

This diagram includes:
- âœ… **Collapsible tables** - Click +/âˆ’ to expand/collapse field lists
- âœ… **Field tooltips** - Hover over fields for descriptions
- âœ… **Edge tooltips** - Hover over arrows to see relationship details
- âœ… **Primary keys** - Colored background and bold text
- âœ… **Foreign keys** - Grouped at top with "FK:" prefix
- âœ… **Enum types** - Fields with constrained values show as "Enum"
- âœ… **Proper layering** - Clean overlapping when tables overlap
- âœ… **Selective shadows** - Only on shapes for depth, not on text

## âš ï¸ Browser Compatibility

| Browser | Max URL Length | Can View? |
|---------|----------------|-----------|
| **Chrome/Edge** | ~2MB | ${urlLength < 2000000 ? 'âœ… Yes' : 'âš ï¸ URL too large'} |
| **Firefox** | ~64KB | ${urlLength < 65536 ? 'âœ… Yes' : 'âš ï¸ Use local file'} |
| **Safari** | ~80KB | ${urlLength < 81920 ? 'âœ… Yes' : 'âš ï¸ Use local file'} |

${urlLength > 65536 ? `
> âš ï¸ **Large Diagram Warning**  
> This diagram's URL (${(urlLength/1024).toFixed(1)}KB) may not work in Firefox or Safari.  
> **Recommended:** Download and open the \`.drawio\` file locally instead.
` : ''}

## ğŸ“š Related

- [â† Back to All Diagrams](../ALL_DIAGRAM_LINKS.md)
- [Main Documentation](../../README.md)
- [View All Diagrams](../../output/)

---

*Generated by board-to-drawio v2.1.0*
`;

    // Write individual diagram file
    const diagramFile = path.join(diagramsDir, `${boardName}.md`);
    fs.writeFileSync(diagramFile, diagramMarkdown, 'utf-8');
    
    console.log(`âœ“ ${boardName.padEnd(25)} â†’ diagrams/${boardName}.md`);
    
    diagrams.push({
      name: boardName,
      displayName,
      nodes: boardData.nodes.length,
      edges: boardData.edges.length,
      urlLength,
      hasAnnotation
    });
    
  } catch (error) {
    console.error(`âœ— ${boardName}: ${error.message}`);
  }
}

// Generate index file
const indexMarkdown = `# ğŸ”— All Diagram Links

**Generated:** ${new Date().toLocaleString()}  
**Total Diagrams:** ${diagrams.length}

> ğŸ“ Each diagram has its own file with viewer URL, download links, and details.

---

## ğŸ“‹ Quick Access

| # | Diagram | Nodes | Edges | Link |
|---|---------|-------|-------|------|
${diagrams.map((d, i) => `| ${i+1} | **${d.displayName}** | ${d.nodes} | ${d.edges} | [View â†’](./diagrams/${d.name}.md) |`).join('\n')}

---

## ğŸ¨ Diagram Features

All diagrams include:
- âœ… **Collapsible tables** - Click +/âˆ’ to expand/collapse
- âœ… **Field tooltips** - Hover for descriptions
- âœ… **Edge tooltips** - Hover arrows to see relationships
- âœ… **Primary keys** - Colored and bold
- âœ… **Foreign keys** - Grouped at top with FK prefix
- âœ… **Enum types** - Fields with constrained values
- âœ… **Proper shadows** - Only on shapes, not text
- âœ… **White field backgrounds** - Clean overlapping
- âœ… **Variable arrow widths** - Emphasis on important relationships

---

## ğŸ“Š Statistics

- **Total Diagrams:** ${diagrams.length}
- **Total Nodes:** ${diagrams.reduce((sum, d) => sum + d.nodes, 0)} tables/entities
- **Total Edges:** ${diagrams.reduce((sum, d) => sum + d.edges, 0)} relationships
- **Largest:** ${diagrams.sort((a, b) => b.nodes - a.nodes)[0].displayName} (${diagrams[0].nodes} nodes)
- **Smallest:** ${diagrams.sort((a, b) => a.nodes - b.nodes)[0].displayName} (${diagrams[0].nodes} nodes)

---

## ğŸ“š Documentation

- **[README](../README.md)** - Main package documentation
- **[QUICK_START.md](./QUICK_START.md)** - Get started in 5 minutes
- **[ANNOTATION_FEATURE.md](./ANNOTATION_FEATURE.md)** - Annotation badges
- **[UML_FEATURE.md](./UML_FEATURE.md)** - UML class diagrams
- **[viewer-urls.md](./viewer-urls.md)** - Technical URL details

---

## ğŸš€ Usage

### View a Diagram
1. Click on any diagram link above
2. Click "Open in draw.io viewer" button
3. View and interact with the diagram in your browser

### Download All Diagrams
All .drawio files are available in the [../output/](../output/) directory.

### Generate Fresh Files
\`\`\`bash
npm run build
node scripts/generate-diagram-files.js
\`\`\`

---

*Generated by board-to-drawio v2.1.0*
`;

// Write index file
fs.writeFileSync(path.join(__dirname, '../docs/ALL_DIAGRAM_LINKS.md'), indexMarkdown, 'utf-8');

console.log('\n' + '='.repeat(60));
console.log(`âœ… Generated ${diagrams.length} individual diagram files`);
console.log('='.repeat(60));
console.log(`ğŸ“„ Index: docs/ALL_DIAGRAM_LINKS.md`);
console.log(`ğŸ“ Files: docs/diagrams/*.md`);
console.log('\nğŸ’¡ View the index at docs/ALL_DIAGRAM_LINKS.md');

